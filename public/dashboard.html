<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracker</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="dashboard-page">

<nav>
  <a class="nav-brand" href="/">
    <img src="/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none';document.getElementById('nav-text').style.display='inline'" />
    <span id="nav-text" style="display:none"><span>Launch</span>Tracker</span>
  </a>
  <a href="/">New Submission</a>
  <a href="/dashboard" class="active">Dashboard</a>
  <button id="logout-btn" class="btn btn-ghost" style="margin-left:auto;padding:.3rem .9rem;font-size:.8rem">Sign Out</button>
</nav>

<div class="page-wide">
  <div class="dashboard-header">
    <div>
      <h1>Site Launch Dashboard</h1>
      <p class="subtitle" style="margin-bottom:0">Track and update the status of every customer site launch.</p>
    </div>
    <a href="/" class="btn btn-primary">+ New Submission</a>
  </div>

  <div class="card">
    <div class="toolbar">
      <input type="search" id="search" placeholder="Search account, domain, or contact‚Ä¶" />
      <select id="filter-industry">
        <option value="all">All Industries</option>
        <option value="Roofing">Roofing</option>
        <option value="Plumbing">Plumbing</option>
        <option value="Electrical">Electrical</option>
        <option value="HVAC">HVAC</option>
        <option value="Landscaping">Landscaping</option>
        <option value="Contracting">Contracting</option>
        <option value="Restoration">Restoration</option>
        <option value="Solar">Solar</option>
        <option value="Flooring">Flooring</option>
      </select>
      <select id="filter-department">
        <option value="all">All Departments</option>
        <option value="Sales">Sales</option>
        <option value="Retention">Retention</option>
        <option value="Customer Success">Customer Success</option>
        <option value="Other">Other</option>
      </select>
      <select id="filter-status">
        <option value="all">All Statuses</option>
        <option value="new">New</option>
        <option value="in_progress">In Progress</option>
        <option value="awaiting_dns">Awaiting DNS Access</option>
        <option value="awaiting_approval">Awaiting Client Approval / Edits</option>
        <option value="launched">Launched / Live</option>
      </select>
      <span class="count" id="row-count"></span>
      <button class="btn btn-ghost" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>

    <div class="table-wrap">
      <table id="launch-table">
        <thead>
          <tr>
            <th class="sticky-col">Account</th>
            <th>Industry</th>
            <th>Department</th>
            <th>Contact</th>
            <th>Phone</th>
            <th>Status</th>
            <th>Status Updated</th>
            <th>Notes</th>
            <th>Submitted</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr>
            <td colspan="8">
              <div class="empty"><p>Loading‚Ä¶</p></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Notes/Detail Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal">
    <h2 id="modal-title">Edit Notes</h2>
    <div style="margin-bottom:1rem;">
      <label for="modal-status">Status</label>
      <select id="modal-status">
        <option value="new">New</option>
        <option value="in_progress">In Progress</option>
        <option value="awaiting_dns">Awaiting DNS Access</option>
        <option value="awaiting_approval">Awaiting Client Approval / Edits</option>
        <option value="launched">Launched / Live</option>
      </select>
    </div>
    <div>
      <label for="modal-notes">Internal Notes</label>
      <textarea id="modal-notes" rows="5" placeholder="Add any internal notes about this launch‚Ä¶" style="resize:vertical"></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="modal-delete">Delete</button>
      <div style="display:flex;gap:.75rem;margin-left:auto">
        <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-save">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-backdrop" id="confirm-modal">
  <div class="modal">
    <h2>Delete this launch?</h2>
    <p style="color:var(--text-muted);font-size:.9rem;margin-top:.5rem">
      This will permanently remove the record. This action cannot be undone.
    </p>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="confirm-cancel">Cancel</button>
      <button class="btn btn-danger" id="confirm-delete">Yes, Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
const STATUS_LABELS = {
  new:               'New',
  in_progress:       'In Progress',
  awaiting_dns:      'Awaiting DNS',
  awaiting_approval: 'Awaiting Approval',
  launched:          'Launched'
};

let allLaunches = [];
let editingId = null;
let deletingId = null;

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show ' + type;
  setTimeout(() => { t.className = ''; }, 3500);
}

function formatDate(iso) {
  if (!iso) return '‚Äî';
  const d = new Date(iso.replace(' ', 'T'));
  if (isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function renderTable(data) {
  const tbody = document.getElementById('table-body');
  document.getElementById('row-count').textContent = `${data.length} record${data.length !== 1 ? 's' : ''}`;

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="10"><div class="empty">
      <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
      </svg>
      <p>No launches found.</p>
    </div></td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(r => `
    <tr data-id="${r.id}">
      <td class="sticky-col">
        <div class="account-name">${esc(r.account_name)}</div>
        <div class="domain">üåê <a href="https://${esc(r.domain_name)}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${esc(r.domain_name)}</a></div>
      </td>
      <td>${esc(r.industry || '‚Äî')}</td>
      <td>${esc(r.department)}</td>
      <td>
        <div>${esc(r.contact_name)}</div>
        <div class="contact-email">${esc(r.email)}</div>
      </td>
      <td style="white-space:nowrap">${esc(r.phone)}</td>
      <td>
        <div class="status-wrap">
          <select class="status-select ${r.status}" data-id="${r.id}" onchange="quickStatus(this)">
            ${Object.entries(STATUS_LABELS).map(([v,l]) =>
              `<option value="${v}"${v === r.status ? ' selected' : ''}>${l}</option>`
            ).join('')}
          </select>
        </div>
      </td>
      <td style="white-space:nowrap;font-size:.8rem;color:var(--text-muted)">${formatDate(r.status_changed_at)}</td>
      <td style="max-width:200px;white-space:pre-wrap;font-size:.8rem;color:var(--text-muted)">${esc(r.notes || '‚Äî')}</td>
      <td style="white-space:nowrap;font-size:.8rem;color:var(--text-muted)">${formatDate(r.created_at)}</td>
      <td>
        <button class="btn btn-ghost" style="padding:.3rem .65rem;font-size:.78rem" onclick="openEdit(${r.id})">Edit</button>
      </td>
    </tr>
  `).join('');
}

function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Quick status change directly in the table dropdown
async function quickStatus(select) {
  const id = select.dataset.id;
  const status = select.value;
  // Update appearance immediately
  select.className = 'status-select ' + status;

  try {
    const res = await fetch(`/api/launches/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    if (!res.ok) throw new Error();
    showToast('Status updated.');
    fetchLaunches();
  } catch {
    showToast('Failed to update status.', 'error');
    fetchLaunches();
  }
}

// ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ
function openEdit(id) {
  const r = allLaunches.find(x => x.id === id);
  if (!r) return;
  editingId = id;
  document.getElementById('modal-title').textContent = `Edit ‚Äî ${r.account_name}`;
  document.getElementById('modal-status').value = r.status;
  document.getElementById('modal-notes').value = r.notes || '';
  document.getElementById('modal').classList.add('open');
}

document.getElementById('modal-cancel').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('open');
});

document.getElementById('modal-delete').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('open');
  openDelete(editingId);
});

document.getElementById('modal-save').addEventListener('click', async () => {
  const status = document.getElementById('modal-status').value;
  const notes = document.getElementById('modal-notes').value;
  const btn = document.getElementById('modal-save');
  btn.disabled = true;
  btn.textContent = 'Saving‚Ä¶';

  try {
    const res = await fetch(`/api/launches/${editingId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status, notes })
    });
    if (!res.ok) throw new Error();
    document.getElementById('modal').classList.remove('open');
    showToast('Changes saved.');
    fetchLaunches();
  } catch {
    showToast('Failed to save changes.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
});

// ‚îÄ‚îÄ Delete Modal ‚îÄ‚îÄ
function openDelete(id) {
  deletingId = id;
  document.getElementById('confirm-modal').classList.add('open');
}

document.getElementById('confirm-cancel').addEventListener('click', () => {
  document.getElementById('confirm-modal').classList.remove('open');
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
  const btn = document.getElementById('confirm-delete');
  btn.disabled = true;
  btn.textContent = 'Deleting‚Ä¶';

  try {
    const res = await fetch(`/api/launches/${deletingId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error();
    document.getElementById('confirm-modal').classList.remove('open');
    showToast('Launch deleted.');
    fetchLaunches();
  } catch {
    showToast('Failed to delete.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Yes, Delete';
  }
});

// Close modals on backdrop click
['modal','confirm-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });
});

// Search & filter with debounce
let debounceTimer;
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchLaunches, 300);
});
document.getElementById('filter-status').addEventListener('change', fetchLaunches);
document.getElementById('filter-department').addEventListener('change', fetchLaunches);
document.getElementById('filter-industry').addEventListener('change', fetchLaunches);

// Redirect to login on 401
async function fetchLaunches() {
  const search = document.getElementById('search').value.trim();
  const status = document.getElementById('filter-status').value;
  const department = document.getElementById('filter-department').value;
  const industry = document.getElementById('filter-industry').value;
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  if (status !== 'all') params.set('status', status);
  if (department !== 'all') params.set('department', department);
  if (industry !== 'all') params.set('industry', industry);

  try {
    const res = await fetch('/api/launches?' + params.toString());
    if (res.status === 401) { window.location.href = '/login'; return; }
    allLaunches = await res.json();
    renderTable(allLaunches);
  } catch {
    showToast('Failed to load launches.', 'error');
  }
}

// Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/login';
});

// ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
async function exportCSV() {
  const res = await fetch('/api/launches');
  if (res.status === 401) { window.location.href = '/login'; return; }
  const data = await res.json();

  const headers = ['Account Name','Domain','Industry','Department','Contact Name','Email','Phone','Status','Notes','Status Updated','Submitted'];
  const STATUS_FULL = {
    new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS Access',
    awaiting_approval: 'Awaiting Client Approval / Edits', launched: 'Launched / Live'
  };

  const rows = data.map(r => [
    r.account_name, r.domain_name, r.industry || '', r.department, r.contact_name,
    r.email, r.phone, STATUS_FULL[r.status] || r.status,
    r.notes || '', formatDate(r.status_changed_at), formatDate(r.created_at)
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `launches-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Initial load
fetchLaunches();
</script>
</body>
</html>
