<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Projects ‚Äî Launch Tracker</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>" />
  <link rel="stylesheet" href="/style.css" />
  <script>document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'light');</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
</head>
<body class="dashboard-page">

<nav>
  <a class="nav-brand" href="/">
    <img src="/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none';document.getElementById('nav-text').style.display='inline'" />
    <span id="nav-text" style="display:none"><span>Launch</span>Tracker</span>
  </a>
  <a href="/dashboard" class="active" title="Projects"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="12" width="4" height="8" rx="1"/><rect x="9" y="7" width="4" height="13" rx="1"/><rect x="16" y="3" width="4" height="17" rx="1"/></svg></a>
  <button id="logout-btn" class="btn btn-ghost" style="margin-left:auto;padding:.3rem .9rem;font-size:.8rem">Sign Out</button>
</nav>

<div class="page-wide">
  <div class="dashboard-header">
    <div>
      <h1>Site Launch Dashboard</h1>
      <p class="subtitle" style="margin-bottom:0">Track and update the status of every customer site launch.</p>
    </div>
    <a href="/" class="btn btn-primary">+ Submit</a>
  </div>

  <div class="card">
    <div class="toolbar">
      <input type="search" id="search" placeholder="Search account, domain, or contact‚Ä¶" />
      <div class="fp-wrap" id="fp-wrap">
        <button class="btn btn-ghost fp-btn" id="fp-btn" onclick="toggleFilterPanel()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
          Filters
          <span class="fp-badge" id="fp-badge">0</span>
        </button>
        <div class="fp-panel" id="fp-panel">
          <div class="fp-panel-header">
            <span class="fp-panel-title">Filters</span>
            <button class="fp-clear-all" onclick="clearAllFilters()">Clear all</button>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Status</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="status" data-value="all" onclick="setFilter('status','all',this)">All</button>
              <button class="fp-chip" data-filter="status" data-value="new" onclick="setFilter('status','new',this)">New</button>
              <button class="fp-chip" data-filter="status" data-value="in_progress" onclick="setFilter('status','in_progress',this)">In Progress</button>
              <button class="fp-chip" data-filter="status" data-value="awaiting_approval" onclick="setFilter('status','awaiting_approval',this)">Approval</button>
              <button class="fp-chip" data-filter="status" data-value="awaiting_dns" onclick="setFilter('status','awaiting_dns',this)">DNS Access</button>
              <button class="fp-chip" data-filter="status" data-value="launched" onclick="setFilter('status','launched',this)">Launched</button>
            </div>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Industry</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="industry" data-value="all" onclick="setFilter('industry','all',this)">All</button>
              <button class="fp-chip" data-filter="industry" data-value="Roofing" onclick="setFilter('industry','Roofing',this)">Roofing</button>
              <button class="fp-chip" data-filter="industry" data-value="Plumbing" onclick="setFilter('industry','Plumbing',this)">Plumbing</button>
              <button class="fp-chip" data-filter="industry" data-value="Electrical" onclick="setFilter('industry','Electrical',this)">Electrical</button>
              <button class="fp-chip" data-filter="industry" data-value="HVAC" onclick="setFilter('industry','HVAC',this)">HVAC</button>
              <button class="fp-chip" data-filter="industry" data-value="Landscaping" onclick="setFilter('industry','Landscaping',this)">Landscaping</button>
              <button class="fp-chip" data-filter="industry" data-value="Contracting" onclick="setFilter('industry','Contracting',this)">Contracting</button>
              <button class="fp-chip" data-filter="industry" data-value="Restoration" onclick="setFilter('industry','Restoration',this)">Restoration</button>
              <button class="fp-chip" data-filter="industry" data-value="Solar" onclick="setFilter('industry','Solar',this)">Solar</button>
              <button class="fp-chip" data-filter="industry" data-value="Flooring" onclick="setFilter('industry','Flooring',this)">Flooring</button>
            </div>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Owner</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="owner" data-value="all" onclick="setFilter('owner','all',this)">All</button>
              <button class="fp-chip" data-filter="owner" data-value="Daniel" onclick="setFilter('owner','Daniel',this)">Daniel</button>
              <button class="fp-chip" data-filter="owner" data-value="Thierry" onclick="setFilter('owner','Thierry',this)">Thierry</button>
            </div>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Department</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="department" data-value="all" onclick="setFilter('department','all',this)">All</button>
              <button class="fp-chip" data-filter="department" data-value="Sales" onclick="setFilter('department','Sales',this)">Sales</button>
              <button class="fp-chip" data-filter="department" data-value="Retention" onclick="setFilter('department','Retention',this)">Retention</button>
              <button class="fp-chip" data-filter="department" data-value="Customer Success" onclick="setFilter('department','Customer Success',this)">Customer Success</button>
              <button class="fp-chip" data-filter="department" data-value="Other" onclick="setFilter('department','Other',this)">Other</button>
            </div>
          </div>
        </div>
      </div>
      <span class="count" id="row-count"></span>
      <div class="view-toggle">
        <button class="view-btn view-btn-active" id="view-table-btn" onclick="setView('table')">Table</button>
        <button class="view-btn" id="view-graph-btn" onclick="setView('graph')">Graph</button>
      </div>
      <button class="btn btn-ghost" id="export-btn" onclick="handleExportClick(this)">‚¨á Export CSV</button>
    </div>

    <div class="table-wrap" id="table-wrap">
      <table id="launch-table">
        <thead>
          <tr>
            <th class="sticky-col">Account</th>
            <th>Industry</th>
            <th>Contact</th>
            <th>Owner</th>
            <th id="status-th" onclick="sortBy('status')" style="cursor:pointer;user-select:none;white-space:nowrap">Status</th>
            <th>Status Age</th>
            <th>Notes</th>
            <th>Department</th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr>
            <td colspan="9">
              <div class="empty"><p>Loading‚Ä¶</p></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Graph View -->
    <div id="chart-area" class="chart-area">
      <div class="chart-header">
        <span class="chart-group-label">Group by</span>
        <div class="chart-group-tabs">
          <button class="chart-group-btn chart-group-btn-active" onclick="setGroupBy('department',this)">Department</button>
          <button class="chart-group-btn" onclick="setGroupBy('industry',this)">Industry</button>
          <button class="chart-group-btn" onclick="setGroupBy('owner',this)">Owner</button>
        </div>
        <div class="chart-summary" id="chart-summary"></div>
      </div>
      <div class="chart-canvas-wrap" id="chart-canvas-wrap">
        <canvas id="progress-chart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal" style="max-width:680px">
    <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:1.25rem">
      <h2 id="modal-title" style="margin-bottom:0">Edit Record</h2>
      <span id="modal-submitted" style="font-size:.78rem;color:var(--text-muted)"></span>
    </div>
    <div class="form-grid" style="margin-bottom:1.25rem">
      <div>
        <label for="modal-industry">Industry</label>
        <select id="modal-industry">
          <option value="">‚Äî None ‚Äî</option>
          <option value="Roofing">Roofing</option>
          <option value="Plumbing">Plumbing</option>
          <option value="Electrical">Electrical</option>
          <option value="HVAC">HVAC</option>
          <option value="Landscaping">Landscaping</option>
          <option value="Contracting">Contracting</option>
          <option value="Restoration">Restoration</option>
          <option value="Solar">Solar</option>
          <option value="Flooring">Flooring</option>
        </select>
      </div>
      <div>
        <label for="modal-department">Department</label>
        <select id="modal-department">
          <option value="Sales">Sales</option>
          <option value="Retention">Retention</option>
          <option value="Customer Success">Customer Success</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="full">
        <label for="modal-account_name">Account Name</label>
        <input type="text" id="modal-account_name" />
      </div>
      <div class="full">
        <label for="modal-domain_name">Domain Name</label>
        <input type="text" id="modal-domain_name" />
      </div>
      <div class="full">
        <label for="modal-contact_name">Contact Name</label>
        <input type="text" id="modal-contact_name" />
      </div>
      <div>
        <label for="modal-email">Email</label>
        <input type="email" id="modal-email" />
      </div>
      <div>
        <label for="modal-phone">Phone</label>
        <input type="tel" id="modal-phone" />
      </div>
      <div class="full">
        <label for="modal-owner">Owner</label>
        <select id="modal-owner">
          <option value="">‚Äî Unassigned ‚Äî</option>
          <option value="Daniel">Daniel</option>
          <option value="Thierry">Thierry</option>
        </select>
      </div>
      <div class="full">
        <label for="modal-status">Status</label>
        <select id="modal-status">
          <option value="new">New</option>
          <option value="in_progress">In Progress</option>
          <option value="awaiting_approval">Awaiting Client Approval / Edits</option>
          <option value="awaiting_dns">Awaiting DNS Access</option>
          <option value="launched">Launched / Live</option>
        </select>
      </div>
      <div class="full">
        <label for="modal-notes">Notes</label>
        <textarea id="modal-notes" rows="3" placeholder="Internal notes‚Ä¶" style="resize:vertical"></textarea>
      </div>
    </div>
    <div id="modal-timeline" style="border-top:1px solid var(--border);padding-top:1rem;margin-top:.25rem">
      <div style="font-size:.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.65rem">Project Timeline</div>
      <div id="modal-timeline-body"><p style="color:var(--text-muted);font-size:.8rem">Loading‚Ä¶</p></div>
    </div>

    <div id="modal-domain-info" style="border-top:1px solid var(--border);padding-top:1rem;margin-top:.25rem">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.65rem">
        <div style="font-size:.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em">Domain Info</div>
        <button class="btn btn-ghost" id="domain-lookup-btn" onclick="lookupDomain()" style="padding:.25rem .65rem;font-size:.75rem">Refresh</button>
      </div>
      <div id="domain-info-body"></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-danger" id="modal-delete">Delete</button>
      <div style="display:flex;gap:.75rem;margin-left:auto">
        <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-save">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-backdrop" id="confirm-modal">
  <div class="modal">
    <h2>Delete this launch?</h2>
    <p style="color:var(--text-muted);font-size:.9rem;margin-top:.5rem">
      This will permanently remove the record. This action cannot be undone.
    </p>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="confirm-cancel">Cancel</button>
      <button class="btn btn-danger" id="confirm-delete">Yes, Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="note-tooltip" class="note-tooltip"></div>

<div id="contact-popup" class="contact-popup">
  <div class="contact-popup-name" id="cp-name"></div>
  <div class="contact-popup-row" id="cp-email"></div>
  <div class="contact-popup-row" id="cp-phone"></div>
</div>

<div id="claim-popup" class="claim-popup">
  <div class="claim-popup-title">Assign to‚Ä¶</div>
  <button class="claim-option" onclick="assignOwner('Daniel')">Daniel</button>
  <button class="claim-option" onclick="assignOwner('Thierry')">Thierry</button>
</div>

<button id="dark-toggle" title="Toggle dark mode" onclick="toggleDark()">üåô</button>

<script>
const STATUS_LABELS = {
  new:               'New',
  in_progress:       'In Progress',
  awaiting_approval: 'Approval',
  awaiting_dns:      'DNS Access',
  launched:          'Launched'
};

let allLaunches = [];
let editingId = null;
let deletingId = null;
const STATUS_ORDER = ['new', 'in_progress', 'awaiting_approval', 'awaiting_dns', 'launched'];

// ‚îÄ‚îÄ Chart / View State ‚îÄ‚îÄ
const STATUS_COLORS = {
  new:               '#ec4899',
  in_progress:       '#3b82f6',
  awaiting_approval: '#f97316',
  awaiting_dns:      '#8b5cf6',
  launched:          '#22c55e',
};
const GROUP_KEYS = {
  department: ['Sales', 'Retention', 'Customer Success', 'Other'],
  industry:   ['Roofing', 'Plumbing', 'Electrical', 'HVAC', 'Landscaping', 'Contracting', 'Restoration', 'Solar', 'Flooring'],
  owner:      ['Daniel', 'Thierry', 'Unassigned'],
};
let viewMode   = 'table';
let groupByDim = 'department';
let chartInstance = null;

function setView(mode) {
  viewMode = mode;
  document.getElementById('view-table-btn').classList.toggle('view-btn-active', mode === 'table');
  document.getElementById('view-graph-btn').classList.toggle('view-btn-active', mode === 'graph');
  document.getElementById('table-wrap').style.display = mode === 'table' ? '' : 'none';
  document.getElementById('chart-area').classList.toggle('visible', mode === 'graph');
  if (mode === 'graph') renderChart();
}

function setGroupBy(dim, btn) {
  groupByDim = dim;
  document.querySelectorAll('.chart-group-btn').forEach(b => b.classList.remove('chart-group-btn-active'));
  btn.classList.add('chart-group-btn-active');
  renderChart();
}

function renderChart() {
  if (viewMode !== 'graph') return;

  // Build groups
  const groups = {};
  for (const key of GROUP_KEYS[groupByDim]) {
    groups[key] = { new: 0, in_progress: 0, awaiting_approval: 0, awaiting_dns: 0, launched: 0 };
  }
  for (const r of allLaunches) {
    const key = groupByDim === 'owner' ? (r.owner || 'Unassigned') : (r[groupByDim] || '‚Äî');
    if (!groups[key]) groups[key] = { new: 0, in_progress: 0, awaiting_approval: 0, awaiting_dns: 0, launched: 0 };
    if (r.status in groups[key]) groups[key][r.status]++;
  }

  // Only show groups with at least one record, sorted by total desc
  const labels = Object.keys(groups)
    .filter(k => STATUS_ORDER.some(s => groups[k][s] > 0))
    .sort((a, b) => {
      const totA = STATUS_ORDER.reduce((n, s) => n + groups[a][s], 0);
      const totB = STATUS_ORDER.reduce((n, s) => n + groups[b][s], 0);
      return totB - totA;
    });

  // Summary stats
  const summaryEl = document.getElementById('chart-summary');
  summaryEl.innerHTML = STATUS_ORDER.map(s => {
    const cnt = allLaunches.filter(r => r.status === s).length;
    if (!cnt) return '';
    return `<div class="chart-stat">
      <div class="chart-stat-dot" style="background:${STATUS_COLORS[s]}"></div>
      <span>${STATUS_LABELS[s]}</span>
      <span class="chart-stat-count">${cnt}</span>
    </div>`;
  }).join('');

  const wrap = document.getElementById('chart-canvas-wrap');

  if (!labels.length) {
    if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
    wrap.innerHTML = '<div class="chart-empty">No data matches the current filters.</div>';
    return;
  }

  // Restore canvas if we showed the empty state
  if (!wrap.querySelector('canvas')) {
    wrap.innerHTML = '<canvas id="progress-chart"></canvas>';
  }

  const isDark    = document.documentElement.getAttribute('data-theme') === 'dark';
  const textColor = isDark ? '#94a3b8' : '#64748b';
  const gridColor = isDark ? '#334155' : '#e2e8f0';

  const datasets = STATUS_ORDER.map(status => ({
    label:           STATUS_LABELS[status],
    data:            labels.map(l => groups[l][status]),
    backgroundColor: STATUS_COLORS[status],
    borderRadius:    3,
    borderSkipped:   false,
  }));

  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  chartInstance = new Chart(document.getElementById('progress-chart'), {
    type: 'bar',
    data: { labels, datasets },
    options: {
      indexAxis: 'y',
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 250 },
      plugins: {
        legend: {
          position: 'top',
          align: 'start',
          labels: {
            color:          textColor,
            font:           { family: '-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif', size: 11, weight: '600' },
            boxWidth:       10,
            boxHeight:      10,
            borderRadius:   3,
            useBorderRadius: true,
            padding:        16,
          },
        },
        tooltip: {
          backgroundColor: isDark ? '#0f172a' : '#1e293b',
          titleColor:      '#f1f5f9',
          bodyColor:       '#94a3b8',
          padding:         10,
          callbacks: {
            title: ([item]) => item.label,
            label: (item)   => ` ${item.dataset.label}: ${item.raw}`,
            footer: (items) => {
              const total = items.reduce((n, i) => n + i.raw, 0);
              return `Total: ${total}`;
            },
          },
        },
      },
      scales: {
        x: {
          stacked: true,
          ticks:  { color: textColor, stepSize: 1, precision: 0 },
          grid:   { color: gridColor },
          border: { color: gridColor },
        },
        y: {
          stacked: true,
          ticks:  { color: textColor, font: { size: 12, weight: '500' } },
          grid:   { display: false },
          border: { display: false },
        },
      },
    },
  });
}

// ‚îÄ‚îÄ Filter Panel State ‚îÄ‚îÄ
const fpState = { status: 'all', industry: 'all', department: 'all', owner: 'all' };

function toggleFilterPanel() {
  const panel = document.getElementById('fp-panel');
  const btn = document.getElementById('fp-btn');
  if (!panel.classList.contains('open')) {
    const rect = btn.getBoundingClientRect();
    panel.style.top = (rect.bottom + 6) + 'px';
    panel.style.left = rect.left + 'px';
  }
  panel.classList.toggle('open');
}

function setFilter(filter, value, btn) {
  fpState[filter] = value;
  document.querySelectorAll(`[data-filter="${filter}"]`).forEach(c => c.classList.remove('fp-chip-active'));
  btn.classList.add('fp-chip-active');
  updateFilterBadge();
  fetchLaunches();
}

function clearAllFilters() {
  ['status', 'industry', 'department', 'owner'].forEach(f => {
    fpState[f] = 'all';
    document.querySelectorAll(`[data-filter="${f}"]`).forEach(c => c.classList.remove('fp-chip-active'));
    const allChip = document.querySelector(`[data-filter="${f}"][data-value="all"]`);
    if (allChip) allChip.classList.add('fp-chip-active');
  });
  updateFilterBadge();
  fetchLaunches();
}

function updateFilterBadge() {
  const count = ['status', 'industry', 'department', 'owner'].filter(f => fpState[f] !== 'all').length;
  const badge = document.getElementById('fp-badge');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline-flex' : 'none';
}

document.addEventListener('click', (e) => {
  const wrap = document.getElementById('fp-wrap');
  if (!wrap.contains(e.target)) {
    document.getElementById('fp-panel').classList.remove('open');
  }
  const cp = document.getElementById('contact-popup');
  if (!cp.contains(e.target) && !e.target.closest('.contact-name-btn')) {
    cp.classList.remove('open');
  }
  const claimPop = document.getElementById('claim-popup');
  if (!claimPop.contains(e.target) && !e.target.closest('.claim-btn') && !e.target.closest('.owner-badge')) {
    claimPop.classList.remove('open');
  }
});

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show ' + type;
  setTimeout(() => { t.className = ''; }, 3500);
}

function handleRowDblClick(e, id) {
  if (e.target.closest('.status-select, .btn, a, .note-dot')) return;
  openEdit(id);
}

function formatDuration(ms) {
  if (ms < 0) ms = 0;
  const totalMins  = Math.floor(ms / 60000);
  const mins       = totalMins % 60;
  const totalHours = Math.floor(totalMins / 60);
  const hours      = totalHours % 24;
  const days       = Math.floor(totalHours / 24);
  const parts = [];
  if (days  > 0) parts.push(`${days}d`);
  if (hours > 0) parts.push(`${hours}h`);
  if (mins  > 0 && days === 0) parts.push(`${mins}m`);
  return parts.length ? parts.join(' ') : 'Just now';
}

const TIMELINE_STATUS_LABELS = {
  new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS',
  awaiting_approval: 'Awaiting Approval', launched: 'Launched'
};

async function loadTimeline(id) {
  const body = document.getElementById('modal-timeline-body');
  body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">Loading‚Ä¶</p>';
  try {
    const res = await fetch(`/api/launches/${id}/history`);
    if (!res.ok) throw new Error();
    const history = await res.json();
    if (!history.length) {
      body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">No timeline data ‚Äî tracking starts on new submissions.</p>';
      return;
    }
    const now = Date.now();
    body.innerHTML = history.map((entry, i) => {
      const start      = toDate(entry.entered_at).getTime();
      const end        = i < history.length - 1 ? toDate(history[i + 1].entered_at).getTime() : now;
      const isCurrent  = i === history.length - 1;
      const isLaunched = entry.status === 'launched';
      const label      = TIMELINE_STATUS_LABELS[entry.status] || entry.status;
      const dur        = isLaunched ? formatDate(entry.entered_at) : formatDuration(end - start);
      const suffix     = isCurrent && !isLaunched ? ' <span class="tl-ongoing">ongoing</span>' : '';
      return `<div class="tl-row${isCurrent ? ' tl-current' : ''}">
        <div class="tl-dot${isCurrent ? ' tl-dot-active' : ''}"></div>
        <div class="tl-label">${label}</div>
        <div class="tl-dur">${dur}${suffix}</div>
      </div>`;
    }).join('');
  } catch {
    body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">Could not load timeline.</p>';
  }
}

// ‚îÄ‚îÄ Status Age Tooltip ‚îÄ‚îÄ
const historyCache = {};

async function showStatusAgeTooltip(e, cell) {
  const id = Number(cell.dataset.id);
  const tip = document.getElementById('note-tooltip');
  const rect = cell.getBoundingClientRect();
  tip.style.top  = (rect.bottom + 6) + 'px';
  tip.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
  tip.innerHTML  = '<span style="opacity:.5;font-size:.78rem">Loading‚Ä¶</span>';
  tip.classList.add('visible');

  if (!historyCache[id]) {
    try {
      const res = await fetch(`/api/launches/${id}/history`);
      historyCache[id] = res.ok ? await res.json() : [];
    } catch { historyCache[id] = []; }
  }

  if (!tip.classList.contains('visible')) return; // moused away
  const history = historyCache[id];
  if (!history.length) {
    tip.innerHTML = '<span style="opacity:.6;font-size:.78rem">No history yet</span>';
    return;
  }

  const LABELS = {
    new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS',
    awaiting_approval: 'Awaiting Approval', launched: 'Launched'
  };
  const now = Date.now();
  const rows = history.map((entry, i) => {
    const start    = toDate(entry.entered_at).getTime();
    const end      = i < history.length - 1 ? toDate(history[i + 1].entered_at).getTime() : now;
    const isCurrent = i === history.length - 1;
    const label    = LABELS[entry.status] || entry.status;
    const dur      = entry.status === 'launched' ? formatDate(entry.entered_at) : formatDuration(end - start);
    return `<div style="display:flex;justify-content:space-between;gap:1.25rem;padding:.12rem 0;${isCurrent ? 'color:#f1f5f9;font-weight:600' : 'opacity:.75'}">
      <span>${label}</span><span>${dur}</span></div>`;
  }).join('');

  tip.innerHTML = `<div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;opacity:.55;margin-bottom:.5rem">Time per Status</div>${rows}`;
}

function showNoteTooltip(e, el) {
  const tip = document.getElementById('note-tooltip');
  tip.textContent = el.dataset.note;
  const rect = el.getBoundingClientRect();
  const left = Math.min(rect.left, window.innerWidth - 260);
  tip.style.top  = (rect.bottom + 6) + 'px';
  tip.style.left = left + 'px';
  tip.classList.add('visible');
}

function hideNoteTooltip() {
  document.getElementById('note-tooltip').classList.remove('visible');
}

function toDate(iso) {
  if (!iso) return null;
  return new Date(iso.replace(' ', 'T') + 'Z'); // treat SQLite UTC as UTC
}

function formatDate(iso) {
  const d = toDate(iso);
  if (!d || isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ‚îÄ‚îÄ Sorting ‚îÄ‚îÄ
let sortState = { col: null, dir: 1 };

function sortBy(col) {
  sortState.dir = sortState.col === col ? sortState.dir * -1 : 1;
  sortState.col = col;
  updateSortHeaders();
  renderTable(allLaunches);
}

function updateSortHeaders() {
  const th = document.getElementById('status-th');
  if (th) th.innerHTML = 'Status' + (sortState.col === 'status' ? ` <span style="opacity:.5;font-size:.65em">${sortState.dir === 1 ? '‚ñ≤' : '‚ñº'}</span>` : '');
}

function renderTable(data) {
  const tbody = document.getElementById('table-body');
  document.getElementById('row-count').textContent = `${data.length} record${data.length !== 1 ? 's' : ''}`;
  if (sortState.col === 'status') {
    data = [...data].sort((a, b) =>
      (STATUS_ORDER.indexOf(a.status) - STATUS_ORDER.indexOf(b.status)) * sortState.dir
    );
  } else if (sortState.col === 'created_at') {
    data = [...data].sort((a, b) =>
      ((toDate(a.created_at) || 0) - (toDate(b.created_at) || 0)) * sortState.dir
    );
  }

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty">
      <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
      </svg>
      <p>No launches found.</p>
    </div></td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(r => `
    <tr data-id="${r.id}" ondblclick="handleRowDblClick(event,${r.id})" style="cursor:pointer" ${r.status === 'launched' ? 'class="row-launched"' : ''}>
      <td class="sticky-col">
        <div class="account-name">${esc(r.account_name)}</div>
        <div class="domain">üåê <a href="https://${esc(r.domain_name)}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${esc(r.domain_name)}</a></div>
      </td>
      <td>${esc(r.industry || '‚Äî')}</td>
      <td>
        <span class="contact-name-btn"
          data-name="${esc(r.contact_name)}"
          data-email="${esc(r.email)}"
          data-phone="${esc(r.phone)}"
          onclick="showContactPopup(event,this)">${esc(r.contact_name)}</span>
      </td>
      <td style="white-space:nowrap">
        ${r.owner
          ? `<span class="owner-badge" data-id="${r.id}" onclick="showClaimPopup(event,this)">${esc(r.owner)}</span>`
          : `<button class="claim-btn" data-id="${r.id}" onclick="showClaimPopup(event,this)">Claim</button>`}
      </td>
      <td>
        <div class="status-wrap">
          <select class="status-select ${r.status}" data-id="${r.id}" onchange="quickStatus(this)">
            ${Object.entries(STATUS_LABELS).map(([v,l]) =>
              `<option value="${v}"${v === r.status ? ' selected' : ''}>${l}</option>`
            ).join('')}
          </select>
        </div>
      </td>
      <td data-id="${r.id}" onmouseenter="showStatusAgeTooltip(event,this)" onmouseleave="hideNoteTooltip()" style="white-space:nowrap;font-size:.8rem;color:var(--text-muted);cursor:help">${r.status === 'launched' ? formatDate(r.status_changed_at || r.created_at) : (r.status_changed_at || r.created_at ? formatDuration(Date.now() - toDate(r.status_changed_at || r.created_at).getTime()) : '‚Äî')}</td>
      <td style="text-align:center">${r.notes ? `<span class="note-dot" data-note="${esc(r.notes)}" onmouseenter="showNoteTooltip(event,this)" onmouseleave="hideNoteTooltip()">¬∑¬∑¬∑</span>` : '<span style="color:var(--text-muted);font-size:.8rem">‚Äî</span>'}</td>
      <td style="font-size:.8rem;color:var(--text-muted)">${esc(r.department)}</td>
    </tr>
  `).join('');
}

function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Quick status change directly in the table dropdown
async function quickStatus(select) {
  const id = select.dataset.id;
  const status = select.value;
  // Update appearance immediately
  select.className = 'status-select ' + status;

  try {
    const res = await fetch(`/api/launches/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    if (!res.ok) throw new Error();
    delete historyCache[id];
    showToast('Status updated.');
    if (status === 'launched') launchConfetti(select);
    fetchLaunches();
  } catch {
    showToast('Failed to update status.', 'error');
    fetchLaunches();
  }
}

// ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ
function openEdit(id) {
  const r = allLaunches.find(x => x.id === id);
  if (!r) return;
  editingId = id;
  document.getElementById('modal-title').textContent = `Edit ‚Äî ${r.account_name}`;
  document.getElementById('modal-submitted').textContent = `Submitted ${formatDate(r.created_at)}`;
  document.getElementById('modal-industry').value     = r.industry || '';
  document.getElementById('modal-department').value   = r.department || '';
  document.getElementById('modal-account_name').value = r.account_name || '';
  document.getElementById('modal-domain_name').value  = r.domain_name || '';
  document.getElementById('modal-contact_name').value = r.contact_name || '';
  document.getElementById('modal-email').value        = r.email || '';
  document.getElementById('modal-phone').value        = r.phone || '';
  document.getElementById('modal-owner').value        = r.owner || '';
  document.getElementById('modal-status').value       = r.status;
  document.getElementById('modal-notes').value        = r.notes || '';
  document.getElementById('modal').classList.add('open');
  loadTimeline(id);
  lookupDomain(r.domain_name);
}

document.getElementById('modal-cancel').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('open');
});

document.getElementById('modal-delete').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('open');
  openDelete(editingId);
});

document.getElementById('modal-save').addEventListener('click', async () => {
  const btn = document.getElementById('modal-save');
  btn.disabled = true;
  btn.textContent = 'Saving‚Ä¶';
  const payload = {
    industry:     document.getElementById('modal-industry').value,
    department:   document.getElementById('modal-department').value,
    account_name: document.getElementById('modal-account_name').value,
    domain_name:  document.getElementById('modal-domain_name').value,
    contact_name: document.getElementById('modal-contact_name').value,
    email:        document.getElementById('modal-email').value,
    phone:        document.getElementById('modal-phone').value,
    owner:        document.getElementById('modal-owner').value,
    status:       document.getElementById('modal-status').value,
    notes:        document.getElementById('modal-notes').value,
  };

  try {
    const res = await fetch(`/api/launches/${editingId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error();
    const wasLaunched = allLaunches.find(x => x.id === editingId)?.status === 'launched';
    delete historyCache[editingId];
    document.getElementById('modal').classList.remove('open');
    showToast('Changes saved.');
    if (payload.status === 'launched' && !wasLaunched) launchConfetti(btn);
    fetchLaunches();
  } catch {
    showToast('Failed to save changes.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
});

// ‚îÄ‚îÄ Delete Modal ‚îÄ‚îÄ
function openDelete(id) {
  deletingId = id;
  document.getElementById('confirm-modal').classList.add('open');
}

document.getElementById('confirm-cancel').addEventListener('click', () => {
  document.getElementById('confirm-modal').classList.remove('open');
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
  const btn = document.getElementById('confirm-delete');
  btn.disabled = true;
  btn.textContent = 'Deleting‚Ä¶';

  try {
    const res = await fetch(`/api/launches/${deletingId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error();
    document.getElementById('confirm-modal').classList.remove('open');
    showToast('Launch deleted.');
    fetchLaunches();
  } catch {
    showToast('Failed to delete.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Yes, Delete';
  }
});

// Close modals on backdrop click
['modal','confirm-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });
});

// Search with debounce
let debounceTimer;
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchLaunches, 300);
});

// Redirect to login on 401
async function fetchLaunches() {
  const search = document.getElementById('search').value.trim();
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  if (fpState.status !== 'all') params.set('status', fpState.status);
  if (fpState.department !== 'all') params.set('department', fpState.department);
  if (fpState.industry !== 'all') params.set('industry', fpState.industry);
  if (fpState.owner !== 'all') params.set('owner', fpState.owner);

  try {
    const res = await fetch('/api/launches?' + params.toString());
    if (res.status === 401) { window.location.href = '/login'; return; }
    allLaunches = await res.json();
    renderTable(allLaunches);
    if (viewMode === 'graph') renderChart();
  } catch {
    showToast('Failed to load launches.', 'error');
  }
}

// Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/login';
});

// ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
async function exportCSV() {
  const res = await fetch('/api/launches');
  if (res.status === 401) { window.location.href = '/login'; return; }
  const data = await res.json();

  const headers = ['Account Name','Domain','Industry','Department','Contact Name','Email','Phone','Status','Notes','Status Updated','Submitted'];
  const STATUS_FULL = {
    new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS Access',
    awaiting_approval: 'Awaiting Client Approval / Edits', launched: 'Launched / Live'
  };

  const rows = data.map(r => [
    r.account_name, r.domain_name, r.industry || '', r.department, r.contact_name,
    r.email, r.phone, STATUS_FULL[r.status] || r.status,
    (r.notes || '').replace(/\r?\n/g, ' '), formatDate(r.status_changed_at), formatDate(r.created_at)
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `launches-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ Export CSV with easter egg ‚îÄ‚îÄ
let exportClicks = 0, exportTimer;
function handleExportClick(btn) {
  exportClicks++;
  clearTimeout(exportTimer);
  exportTimer = setTimeout(() => {
    const n = exportClicks;
    exportClicks = 0;
    if (n >= 3) easterEgg(btn);
    else exportCSV();
  }, 350);
}

function easterEgg(btn) {
  const emojis = ['‚ôî','‚ôï','‚ôñ','‚ôó','‚ôò','‚ôô','‚ôö','‚ôõ','‚ôú','‚ôù','‚ôû','‚ôü'];
  const rect = btn.getBoundingClientRect();
  for (let i = 0; i < 14; i++) {
    setTimeout(() => {
      const el = document.createElement('span');
      el.className = 'easter-emoji';
      el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
      el.style.left = (rect.left + Math.random() * rect.width) + 'px';
      el.style.top  = rect.bottom + 'px';
      el.style.setProperty('--ex', (Math.random() - 0.5) * 120 + 'px');
      el.style.setProperty('--er', (Math.random() * 540 - 270) + 'deg');
      el.style.animationDelay = (Math.random() * 0.2) + 's';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    }, i * 40);
  }
}

// ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ
function launchConfetti(originEl) {
  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9999';
  document.body.appendChild(canvas);
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');

  const rect = originEl.getBoundingClientRect();
  const ox = rect.left + rect.width  / 2;
  const oy = rect.top  + rect.height / 2;
  const colors = ['#22c55e','#16a34a','#4ade80','#fbbf24','#60a5fa','#f472b6','#a78bfa','#fb923c'];

  const particles = Array.from({ length: 72 }, () => ({
    x: ox, y: oy,
    vx: (Math.random() - 0.5) * 14,
    vy: (Math.random() - 0.9) * 14,
    color: colors[Math.floor(Math.random() * colors.length)],
    w: Math.random() * 7 + 3,
    h: Math.random() * 4 + 2,
    rot: Math.random() * 360,
    rotV: (Math.random() - 0.5) * 12,
    opacity: 1,
  }));

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let alive = false;
    for (const p of particles) {
      p.x += p.vx; p.y += p.vy;
      p.vy += 0.35;
      p.rot += p.rotV;
      p.opacity -= 0.013;
      if (p.opacity <= 0) continue;
      alive = true;
      ctx.save();
      ctx.globalAlpha = p.opacity;
      ctx.fillStyle = p.color;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      ctx.restore();
    }
    if (alive) requestAnimationFrame(draw);
    else canvas.remove();
  }
  draw();
}

// ‚îÄ‚îÄ Contact Popup ‚îÄ‚îÄ
function showContactPopup(e, el) {
  e.stopPropagation();
  const popup = document.getElementById('contact-popup');
  document.getElementById('cp-name').textContent  = el.dataset.name;
  document.getElementById('cp-email').innerHTML   = `<a href="mailto:${esc(el.dataset.email)}">${esc(el.dataset.email)}</a>`;
  document.getElementById('cp-phone').textContent = el.dataset.phone;
  const rect = el.getBoundingClientRect();
  popup.style.top  = (rect.bottom + 6) + 'px';
  popup.style.left = Math.min(rect.left, window.innerWidth - 220) + 'px';
  popup.classList.add('open');
}

// ‚îÄ‚îÄ Claim / Owner Popup ‚îÄ‚îÄ
let claimingId = null;
function showClaimPopup(e, el) {
  e.stopPropagation();
  claimingId = Number(el.dataset.id);
  const popup = document.getElementById('claim-popup');
  const rect = el.getBoundingClientRect();
  popup.style.top  = (rect.bottom + 6) + 'px';
  popup.style.left = Math.min(rect.left, window.innerWidth - 160) + 'px';
  popup.classList.add('open');
}

async function assignOwner(name) {
  document.getElementById('claim-popup').classList.remove('open');
  if (!claimingId) return;
  try {
    const res = await fetch(`/api/launches/${claimingId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ owner: name })
    });
    if (!res.ok) throw new Error();
    fetchLaunches();
  } catch {
    showToast('Failed to assign owner.', 'error');
  }
}

// ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ
function toggleDark() {
  const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  document.getElementById('dark-toggle').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  if (viewMode === 'graph') renderChart();
}
(function() {
  const saved = localStorage.getItem('theme') || 'light';
  document.getElementById('dark-toggle').textContent = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
})();

// ‚îÄ‚îÄ Domain Info (RDAP) ‚îÄ‚îÄ
const domainInfoCache = {};

async function lookupDomain(domain) {
  domain = (domain || document.getElementById('modal-domain_name').value).trim().toLowerCase().replace(/^https?:\/\//, '').split('/')[0];
  if (!domain) return;

  const body = document.getElementById('domain-info-body');
  const btn  = document.getElementById('domain-lookup-btn');
  body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">Looking up‚Ä¶</p>';
  btn.disabled = true;

  if (domainInfoCache[domain]) {
    renderDomainInfo(domainInfoCache[domain]);
    btn.disabled = false;
    return;
  }

  try {
    const res  = await fetch(`/api/domain-info/${encodeURIComponent(domain)}`);
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || 'Lookup failed.');
    domainInfoCache[domain] = data;
    renderDomainInfo(data);
  } catch (err) {
    body.innerHTML = `<p style="color:var(--text-muted);font-size:.8rem">${esc(err.message)}</p>`;
  } finally {
    btn.disabled = false;
  }
}

function renderDomainInfo(data) {
  const body = document.getElementById('domain-info-body');
  const fmt  = iso => iso ? new Date(iso).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '‚Äî';

  const now     = Date.now();
  const expires = data.expires ? new Date(data.expires) : null;
  const daysLeft = expires ? Math.ceil((expires - now) / 86400000) : null;
  const expiryWarning = daysLeft !== null && daysLeft < 60
    ? ` <span style="color:#f97316;font-weight:700">(${daysLeft}d left)</span>` : '';

  const rows = [
    ['Registrar',    esc(data.registrar || '‚Äî')],
    ['Created',      fmt(data.created)],
    ['Expires',      fmt(data.expires) + expiryWarning],
    ['Nameservers',  data.nameservers?.length
      ? data.nameservers.map(ns => `<span style="display:block">${esc(ns)}</span>`).join('')
      : '‚Äî'],
  ];

  body.innerHTML = rows.map(([label, value]) =>
    `<div style="display:flex;justify-content:space-between;gap:1rem;padding:.2rem 0;font-size:.82rem;border-bottom:1px solid var(--border)">
      <span style="color:var(--text-muted);font-weight:600;white-space:nowrap">${label}</span>
      <span style="text-align:right;word-break:break-all">${value}</span>
    </div>`
  ).join('');
}

// Initial load
fetchLaunches();
</script>
</body>
</html>
