<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Projects ‚Äî Launch Tracker</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåê</text></svg>" />
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="dashboard-page">

<nav>
  <a class="nav-brand" href="/">
    <img src="/logo.png" alt="Logo" class="nav-logo" onerror="this.style.display='none';document.getElementById('nav-text').style.display='inline'" />
    <span id="nav-text" style="display:none"><span>Launch</span>Tracker</span>
  </a>
  <a href="/"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 114 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>Submit</a>
  <a href="/dashboard" class="active"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="12" width="4" height="8" rx="1"/><rect x="9" y="7" width="4" height="13" rx="1"/><rect x="16" y="3" width="4" height="17" rx="1"/></svg>Projects</a>
  <button id="logout-btn" class="btn btn-ghost" style="margin-left:auto;padding:.3rem .9rem;font-size:.8rem">Sign Out</button>
</nav>

<div class="page-wide">
  <div class="dashboard-header">
    <div>
      <h1>Site Launch Dashboard</h1>
      <p class="subtitle" style="margin-bottom:0">Track and update the status of every customer site launch.</p>
    </div>
    <a href="/" class="btn btn-primary">+ Submit</a>
  </div>

  <div class="card">
    <div class="toolbar">
      <input type="search" id="search" placeholder="Search account, domain, or contact‚Ä¶" />
      <div class="fp-wrap" id="fp-wrap">
        <button class="btn btn-ghost fp-btn" id="fp-btn" onclick="toggleFilterPanel()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
          Filters
          <span class="fp-badge" id="fp-badge">0</span>
        </button>
        <div class="fp-panel" id="fp-panel">
          <div class="fp-panel-header">
            <span class="fp-panel-title">Filters</span>
            <button class="fp-clear-all" onclick="clearAllFilters()">Clear all</button>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Status</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="status" data-value="all" onclick="setFilter('status','all',this)">All</button>
              <button class="fp-chip" data-filter="status" data-value="new" onclick="setFilter('status','new',this)">New</button>
              <button class="fp-chip" data-filter="status" data-value="in_progress" onclick="setFilter('status','in_progress',this)">In Progress</button>
              <button class="fp-chip" data-filter="status" data-value="awaiting_dns" onclick="setFilter('status','awaiting_dns',this)">Awaiting DNS</button>
              <button class="fp-chip" data-filter="status" data-value="awaiting_approval" onclick="setFilter('status','awaiting_approval',this)">Awaiting Approval</button>
              <button class="fp-chip" data-filter="status" data-value="launched" onclick="setFilter('status','launched',this)">Launched</button>
            </div>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Industry</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="industry" data-value="all" onclick="setFilter('industry','all',this)">All</button>
              <button class="fp-chip" data-filter="industry" data-value="Roofing" onclick="setFilter('industry','Roofing',this)">Roofing</button>
              <button class="fp-chip" data-filter="industry" data-value="Plumbing" onclick="setFilter('industry','Plumbing',this)">Plumbing</button>
              <button class="fp-chip" data-filter="industry" data-value="Electrical" onclick="setFilter('industry','Electrical',this)">Electrical</button>
              <button class="fp-chip" data-filter="industry" data-value="HVAC" onclick="setFilter('industry','HVAC',this)">HVAC</button>
              <button class="fp-chip" data-filter="industry" data-value="Landscaping" onclick="setFilter('industry','Landscaping',this)">Landscaping</button>
              <button class="fp-chip" data-filter="industry" data-value="Contracting" onclick="setFilter('industry','Contracting',this)">Contracting</button>
              <button class="fp-chip" data-filter="industry" data-value="Restoration" onclick="setFilter('industry','Restoration',this)">Restoration</button>
              <button class="fp-chip" data-filter="industry" data-value="Solar" onclick="setFilter('industry','Solar',this)">Solar</button>
              <button class="fp-chip" data-filter="industry" data-value="Flooring" onclick="setFilter('industry','Flooring',this)">Flooring</button>
            </div>
          </div>
          <div class="fp-group">
            <div class="fp-group-label">Department</div>
            <div class="fp-chips">
              <button class="fp-chip fp-chip-active" data-filter="department" data-value="all" onclick="setFilter('department','all',this)">All</button>
              <button class="fp-chip" data-filter="department" data-value="Sales" onclick="setFilter('department','Sales',this)">Sales</button>
              <button class="fp-chip" data-filter="department" data-value="Retention" onclick="setFilter('department','Retention',this)">Retention</button>
              <button class="fp-chip" data-filter="department" data-value="Customer Success" onclick="setFilter('department','Customer Success',this)">Customer Success</button>
              <button class="fp-chip" data-filter="department" data-value="Other" onclick="setFilter('department','Other',this)">Other</button>
            </div>
          </div>
        </div>
      </div>
      <span class="count" id="row-count"></span>
      <button class="btn btn-ghost" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>

    <div class="table-wrap">
      <table id="launch-table">
        <thead>
          <tr>
            <th class="sticky-col">Account</th>
            <th>Industry</th>
            <th>Contact</th>
            <th id="status-th" onclick="sortBy('status')" style="cursor:pointer;user-select:none;white-space:nowrap">Status</th>
            <th>Status Age</th>
            <th>Notes</th>
            <th>Department</th>
            <th id="submitted-th" onclick="sortBy('created_at')" style="cursor:pointer;user-select:none;white-space:nowrap">Submitted</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="table-body">
          <tr>
            <td colspan="8">
              <div class="empty"><p>Loading‚Ä¶</p></div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-backdrop" id="modal">
  <div class="modal" style="max-width:680px">
    <h2 id="modal-title">Edit Record</h2>
    <div class="form-grid" style="margin-bottom:1.25rem">
      <div>
        <label for="modal-industry">Industry</label>
        <select id="modal-industry">
          <option value="">‚Äî None ‚Äî</option>
          <option value="Roofing">Roofing</option>
          <option value="Plumbing">Plumbing</option>
          <option value="Electrical">Electrical</option>
          <option value="HVAC">HVAC</option>
          <option value="Landscaping">Landscaping</option>
          <option value="Contracting">Contracting</option>
          <option value="Restoration">Restoration</option>
          <option value="Solar">Solar</option>
          <option value="Flooring">Flooring</option>
        </select>
      </div>
      <div>
        <label for="modal-department">Department</label>
        <select id="modal-department">
          <option value="Sales">Sales</option>
          <option value="Retention">Retention</option>
          <option value="Customer Success">Customer Success</option>
          <option value="Other">Other</option>
        </select>
      </div>
      <div class="full">
        <label for="modal-account_name">Account Name</label>
        <input type="text" id="modal-account_name" />
      </div>
      <div class="full">
        <label for="modal-domain_name">Domain Name</label>
        <input type="text" id="modal-domain_name" />
      </div>
      <div class="full">
        <label for="modal-contact_name">Contact Name</label>
        <input type="text" id="modal-contact_name" />
      </div>
      <div>
        <label for="modal-email">Email</label>
        <input type="email" id="modal-email" />
      </div>
      <div>
        <label for="modal-phone">Phone</label>
        <input type="tel" id="modal-phone" />
      </div>
      <div class="full">
        <label for="modal-status">Status</label>
        <select id="modal-status">
          <option value="new">New</option>
          <option value="in_progress">In Progress</option>
          <option value="awaiting_dns">Awaiting DNS Access</option>
          <option value="awaiting_approval">Awaiting Client Approval / Edits</option>
          <option value="launched">Launched / Live</option>
        </select>
      </div>
      <div class="full">
        <label for="modal-notes">Notes</label>
        <textarea id="modal-notes" rows="3" placeholder="Internal notes‚Ä¶" style="resize:vertical"></textarea>
      </div>
    </div>
    <div id="modal-timeline" style="border-top:1px solid var(--border);padding-top:1rem;margin-top:.25rem">
      <div style="font-size:.72rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.65rem">Project Timeline</div>
      <div id="modal-timeline-body"><p style="color:var(--text-muted);font-size:.8rem">Loading‚Ä¶</p></div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-danger" id="modal-delete">Delete</button>
      <div style="display:flex;gap:.75rem;margin-left:auto">
        <button class="btn btn-ghost" id="modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="modal-save">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-backdrop" id="confirm-modal">
  <div class="modal">
    <h2>Delete this launch?</h2>
    <p style="color:var(--text-muted);font-size:.9rem;margin-top:.5rem">
      This will permanently remove the record. This action cannot be undone.
    </p>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="confirm-cancel">Cancel</button>
      <button class="btn btn-danger" id="confirm-delete">Yes, Delete</button>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="note-tooltip" class="note-tooltip"></div>

<script>
const STATUS_LABELS = {
  new:               'New',
  in_progress:       'In Progress',
  awaiting_dns:      'DNS Access',
  awaiting_approval: 'Approval',
  launched:          'Launched'
};

let allLaunches = [];
let editingId = null;
let deletingId = null;
const STATUS_ORDER = ['new', 'in_progress', 'awaiting_dns', 'awaiting_approval', 'launched'];

// ‚îÄ‚îÄ Filter Panel State ‚îÄ‚îÄ
const fpState = { status: 'all', industry: 'all', department: 'all' };

function toggleFilterPanel() {
  const panel = document.getElementById('fp-panel');
  const btn = document.getElementById('fp-btn');
  if (!panel.classList.contains('open')) {
    const rect = btn.getBoundingClientRect();
    panel.style.top = (rect.bottom + 6) + 'px';
    panel.style.left = rect.left + 'px';
  }
  panel.classList.toggle('open');
}

function setFilter(filter, value, btn) {
  fpState[filter] = value;
  document.querySelectorAll(`[data-filter="${filter}"]`).forEach(c => c.classList.remove('fp-chip-active'));
  btn.classList.add('fp-chip-active');
  updateFilterBadge();
  fetchLaunches();
}

function clearAllFilters() {
  ['status', 'industry', 'department'].forEach(f => {
    fpState[f] = 'all';
    document.querySelectorAll(`[data-filter="${f}"]`).forEach(c => c.classList.remove('fp-chip-active'));
    const allChip = document.querySelector(`[data-filter="${f}"][data-value="all"]`);
    if (allChip) allChip.classList.add('fp-chip-active');
  });
  updateFilterBadge();
  fetchLaunches();
}

function updateFilterBadge() {
  const count = ['status', 'industry', 'department'].filter(f => fpState[f] !== 'all').length;
  const badge = document.getElementById('fp-badge');
  badge.textContent = count;
  badge.style.display = count > 0 ? 'inline-flex' : 'none';
}

document.addEventListener('click', (e) => {
  const wrap = document.getElementById('fp-wrap');
  if (!wrap.contains(e.target)) {
    document.getElementById('fp-panel').classList.remove('open');
  }
});

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'show ' + type;
  setTimeout(() => { t.className = ''; }, 3500);
}

function handleRowDblClick(e, id) {
  if (e.target.closest('.status-select, .btn, a, .note-dot')) return;
  openEdit(id);
}

function formatDuration(ms) {
  if (ms < 0) ms = 0;
  const totalMins  = Math.floor(ms / 60000);
  const mins       = totalMins % 60;
  const totalHours = Math.floor(totalMins / 60);
  const hours      = totalHours % 24;
  const days       = Math.floor(totalHours / 24);
  const parts = [];
  if (days  > 0) parts.push(`${days}d`);
  if (hours > 0) parts.push(`${hours}h`);
  if (mins  > 0 && days === 0) parts.push(`${mins}m`);
  return parts.length ? parts.join(' ') : 'Just now';
}

const TIMELINE_STATUS_LABELS = {
  new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS',
  awaiting_approval: 'Awaiting Approval', launched: 'Launched'
};

async function loadTimeline(id) {
  const body = document.getElementById('modal-timeline-body');
  body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">Loading‚Ä¶</p>';
  try {
    const res = await fetch(`/api/launches/${id}/history`);
    if (!res.ok) throw new Error();
    const history = await res.json();
    if (!history.length) {
      body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">No timeline data ‚Äî tracking starts on new submissions.</p>';
      return;
    }
    const now = Date.now();
    body.innerHTML = history.map((entry, i) => {
      const start = toDate(entry.entered_at).getTime();
      const end   = i < history.length - 1
        ? toDate(history[i + 1].entered_at).getTime()
        : now;
      const isCurrent = i === history.length - 1;
      const label = TIMELINE_STATUS_LABELS[entry.status] || entry.status;
      const dur   = formatDuration(end - start);
      return `<div class="tl-row${isCurrent ? ' tl-current' : ''}">
        <div class="tl-dot${isCurrent ? ' tl-dot-active' : ''}"></div>
        <div class="tl-label">${label}</div>
        <div class="tl-dur">${dur}${isCurrent ? ' <span class="tl-ongoing">ongoing</span>' : ''}</div>
      </div>`;
    }).join('');
  } catch {
    body.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem">Could not load timeline.</p>';
  }
}

// ‚îÄ‚îÄ Status Age Tooltip ‚îÄ‚îÄ
const historyCache = {};

async function showStatusAgeTooltip(e, cell) {
  const id = Number(cell.dataset.id);
  const tip = document.getElementById('note-tooltip');
  const rect = cell.getBoundingClientRect();
  tip.style.top  = (rect.bottom + 6) + 'px';
  tip.style.left = Math.min(rect.left, window.innerWidth - 260) + 'px';
  tip.innerHTML  = '<span style="opacity:.5;font-size:.78rem">Loading‚Ä¶</span>';
  tip.classList.add('visible');

  if (!historyCache[id]) {
    try {
      const res = await fetch(`/api/launches/${id}/history`);
      historyCache[id] = res.ok ? await res.json() : [];
    } catch { historyCache[id] = []; }
  }

  if (!tip.classList.contains('visible')) return; // moused away
  const history = historyCache[id];
  if (!history.length) {
    tip.innerHTML = '<span style="opacity:.6;font-size:.78rem">No history yet</span>';
    return;
  }

  const LABELS = {
    new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS',
    awaiting_approval: 'Awaiting Approval', launched: 'Launched'
  };
  const now = Date.now();
  const rows = history.map((entry, i) => {
    const start    = toDate(entry.entered_at).getTime();
    const end      = i < history.length - 1 ? toDate(history[i + 1].entered_at).getTime() : now;
    const isCurrent = i === history.length - 1;
    const label    = LABELS[entry.status] || entry.status;
    const dur      = entry.status === 'launched' ? formatDate(entry.entered_at) : formatDuration(end - start);
    return `<div style="display:flex;justify-content:space-between;gap:1.25rem;padding:.12rem 0;${isCurrent ? 'color:#f1f5f9;font-weight:600' : 'opacity:.75'}">
      <span>${label}</span><span>${dur}</span></div>`;
  }).join('');

  tip.innerHTML = `<div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;opacity:.55;margin-bottom:.5rem">Time per Status</div>${rows}`;
}

function showNoteTooltip(e, el) {
  const tip = document.getElementById('note-tooltip');
  tip.textContent = el.dataset.note;
  const rect = el.getBoundingClientRect();
  const left = Math.min(rect.left, window.innerWidth - 260);
  tip.style.top  = (rect.bottom + 6) + 'px';
  tip.style.left = left + 'px';
  tip.classList.add('visible');
}

function hideNoteTooltip() {
  document.getElementById('note-tooltip').classList.remove('visible');
}

function toDate(iso) {
  if (!iso) return null;
  return new Date(iso.replace(' ', 'T') + 'Z'); // treat SQLite UTC as UTC
}

function formatDate(iso) {
  const d = toDate(iso);
  if (!d || isNaN(d.getTime())) return '‚Äî';
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ‚îÄ‚îÄ Sorting ‚îÄ‚îÄ
let sortState = { col: null, dir: 1 };

function sortBy(col) {
  sortState.dir = sortState.col === col ? sortState.dir * -1 : 1;
  sortState.col = col;
  updateSortHeaders();
  renderTable(allLaunches);
}

function updateSortHeaders() {
  [['status-th', 'Status'], ['submitted-th', 'Submitted']].forEach(([id, label]) => {
    const th = document.getElementById(id);
    if (!th) return;
    const active = (id === 'status-th' && sortState.col === 'status') ||
                   (id === 'submitted-th' && sortState.col === 'created_at');
    th.innerHTML = label + (active ? ` <span style="opacity:.5;font-size:.65em">${sortState.dir === 1 ? '‚ñ≤' : '‚ñº'}</span>` : '');
  });
}

function renderTable(data) {
  const tbody = document.getElementById('table-body');
  document.getElementById('row-count').textContent = `${data.length} record${data.length !== 1 ? 's' : ''}`;
  if (sortState.col === 'status') {
    data = [...data].sort((a, b) =>
      (STATUS_ORDER.indexOf(a.status) - STATUS_ORDER.indexOf(b.status)) * sortState.dir
    );
  } else if (sortState.col === 'created_at') {
    data = [...data].sort((a, b) =>
      ((toDate(a.created_at) || 0) - (toDate(b.created_at) || 0)) * sortState.dir
    );
  }

  if (!data.length) {
    tbody.innerHTML = `<tr><td colspan="9"><div class="empty">
      <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
          d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
      </svg>
      <p>No launches found.</p>
    </div></td></tr>`;
    return;
  }

  tbody.innerHTML = data.map(r => `
    <tr data-id="${r.id}" ondblclick="handleRowDblClick(event,${r.id})" style="cursor:pointer" ${r.status === 'launched' ? 'class="row-launched"' : ''}>
      <td class="sticky-col">
        <div class="account-name">${esc(r.account_name)}</div>
        <div class="domain">üåê <a href="https://${esc(r.domain_name)}" target="_blank" rel="noopener" style="color:var(--primary);text-decoration:none" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">${esc(r.domain_name)}</a></div>
      </td>
      <td>${esc(r.industry || '‚Äî')}</td>
      <td>
        <div>${esc(r.contact_name)}</div>
        <div class="contact-email">${esc(r.email)}</div>
        <div class="contact-email">${esc(r.phone)}</div>
      </td>
      <td>
        <div class="status-wrap">
          <select class="status-select ${r.status}" data-id="${r.id}" onchange="quickStatus(this)">
            ${Object.entries(STATUS_LABELS).map(([v,l]) =>
              `<option value="${v}"${v === r.status ? ' selected' : ''}>${l}</option>`
            ).join('')}
          </select>
        </div>
      </td>
      <td data-id="${r.id}" onmouseenter="showStatusAgeTooltip(event,this)" onmouseleave="hideNoteTooltip()" style="white-space:nowrap;font-size:.8rem;color:var(--text-muted);cursor:help">${r.status === 'launched' ? formatDate(r.status_changed_at || r.created_at) : (r.status_changed_at || r.created_at ? formatDuration(Date.now() - toDate(r.status_changed_at || r.created_at).getTime()) : '‚Äî')}</td>
      <td style="text-align:center">${r.notes ? `<span class="note-dot" data-note="${esc(r.notes)}" onmouseenter="showNoteTooltip(event,this)" onmouseleave="hideNoteTooltip()">¬∑¬∑¬∑</span>` : '<span style="color:var(--text-muted);font-size:.8rem">‚Äî</span>'}</td>
      <td style="font-size:.8rem;color:var(--text-muted)">${esc(r.department)}</td>
      <td style="white-space:nowrap;font-size:.8rem;color:var(--text-muted)">${formatDate(r.created_at)}</td>
      <td>
        <button class="btn btn-ghost" style="padding:.3rem .65rem;font-size:.78rem" onclick="openEdit(${r.id})">Edit</button>
      </td>
    </tr>
  `).join('');
}

function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Quick status change directly in the table dropdown
async function quickStatus(select) {
  const id = select.dataset.id;
  const status = select.value;
  // Update appearance immediately
  select.className = 'status-select ' + status;

  try {
    const res = await fetch(`/api/launches/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status })
    });
    if (!res.ok) throw new Error();
    delete historyCache[id];
    showToast('Status updated.');
    if (status === 'launched') launchConfetti(select);
    fetchLaunches();
  } catch {
    showToast('Failed to update status.', 'error');
    fetchLaunches();
  }
}

// ‚îÄ‚îÄ Edit Modal ‚îÄ‚îÄ
function openEdit(id) {
  const r = allLaunches.find(x => x.id === id);
  if (!r) return;
  editingId = id;
  document.getElementById('modal-title').textContent = `Edit ‚Äî ${r.account_name}`;
  document.getElementById('modal-industry').value     = r.industry || '';
  document.getElementById('modal-department').value   = r.department || '';
  document.getElementById('modal-account_name').value = r.account_name || '';
  document.getElementById('modal-domain_name').value  = r.domain_name || '';
  document.getElementById('modal-contact_name').value = r.contact_name || '';
  document.getElementById('modal-email').value        = r.email || '';
  document.getElementById('modal-phone').value        = r.phone || '';
  document.getElementById('modal-status').value       = r.status;
  document.getElementById('modal-notes').value        = r.notes || '';
  document.getElementById('modal').classList.add('open');
  loadTimeline(id);
}

document.getElementById('modal-cancel').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('open');
});

document.getElementById('modal-delete').addEventListener('click', () => {
  document.getElementById('modal').classList.remove('open');
  openDelete(editingId);
});

document.getElementById('modal-save').addEventListener('click', async () => {
  const btn = document.getElementById('modal-save');
  btn.disabled = true;
  btn.textContent = 'Saving‚Ä¶';
  const payload = {
    industry:     document.getElementById('modal-industry').value,
    department:   document.getElementById('modal-department').value,
    account_name: document.getElementById('modal-account_name').value,
    domain_name:  document.getElementById('modal-domain_name').value,
    contact_name: document.getElementById('modal-contact_name').value,
    email:        document.getElementById('modal-email').value,
    phone:        document.getElementById('modal-phone').value,
    status:       document.getElementById('modal-status').value,
    notes:        document.getElementById('modal-notes').value,
  };

  try {
    const res = await fetch(`/api/launches/${editingId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!res.ok) throw new Error();
    const wasLaunched = allLaunches.find(x => x.id === editingId)?.status === 'launched';
    delete historyCache[editingId];
    document.getElementById('modal').classList.remove('open');
    showToast('Changes saved.');
    if (payload.status === 'launched' && !wasLaunched) launchConfetti(btn);
    fetchLaunches();
  } catch {
    showToast('Failed to save changes.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Save Changes';
  }
});

// ‚îÄ‚îÄ Delete Modal ‚îÄ‚îÄ
function openDelete(id) {
  deletingId = id;
  document.getElementById('confirm-modal').classList.add('open');
}

document.getElementById('confirm-cancel').addEventListener('click', () => {
  document.getElementById('confirm-modal').classList.remove('open');
});

document.getElementById('confirm-delete').addEventListener('click', async () => {
  const btn = document.getElementById('confirm-delete');
  btn.disabled = true;
  btn.textContent = 'Deleting‚Ä¶';

  try {
    const res = await fetch(`/api/launches/${deletingId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error();
    document.getElementById('confirm-modal').classList.remove('open');
    showToast('Launch deleted.');
    fetchLaunches();
  } catch {
    showToast('Failed to delete.', 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Yes, Delete';
  }
});

// Close modals on backdrop click
['modal','confirm-modal'].forEach(id => {
  document.getElementById(id).addEventListener('click', (e) => {
    if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
  });
});

// Search with debounce
let debounceTimer;
document.getElementById('search').addEventListener('input', () => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fetchLaunches, 300);
});

// Redirect to login on 401
async function fetchLaunches() {
  const search = document.getElementById('search').value.trim();
  const params = new URLSearchParams();
  if (search) params.set('search', search);
  if (fpState.status !== 'all') params.set('status', fpState.status);
  if (fpState.department !== 'all') params.set('department', fpState.department);
  if (fpState.industry !== 'all') params.set('industry', fpState.industry);

  try {
    const res = await fetch('/api/launches?' + params.toString());
    if (res.status === 401) { window.location.href = '/login'; return; }
    allLaunches = await res.json();
    renderTable(allLaunches);
  } catch {
    showToast('Failed to load launches.', 'error');
  }
}

// Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
  await fetch('/api/auth/logout', { method: 'POST' });
  window.location.href = '/login';
});

// ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
async function exportCSV() {
  const res = await fetch('/api/launches');
  if (res.status === 401) { window.location.href = '/login'; return; }
  const data = await res.json();

  const headers = ['Account Name','Domain','Industry','Department','Contact Name','Email','Phone','Status','Notes','Status Updated','Submitted'];
  const STATUS_FULL = {
    new: 'New', in_progress: 'In Progress', awaiting_dns: 'Awaiting DNS Access',
    awaiting_approval: 'Awaiting Client Approval / Edits', launched: 'Launched / Live'
  };

  const rows = data.map(r => [
    r.account_name, r.domain_name, r.industry || '', r.department, r.contact_name,
    r.email, r.phone, STATUS_FULL[r.status] || r.status,
    (r.notes || '').replace(/\r?\n/g, ' '), formatDate(r.status_changed_at), formatDate(r.created_at)
  ].map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));

  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `launches-${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ
function launchConfetti(originEl) {
  const canvas = document.createElement('canvas');
  canvas.style.cssText = 'position:fixed;inset:0;width:100%;height:100%;pointer-events:none;z-index:9999';
  document.body.appendChild(canvas);
  canvas.width  = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');

  const rect = originEl.getBoundingClientRect();
  const ox = rect.left + rect.width  / 2;
  const oy = rect.top  + rect.height / 2;
  const colors = ['#22c55e','#16a34a','#4ade80','#fbbf24','#60a5fa','#f472b6','#a78bfa','#fb923c'];

  const particles = Array.from({ length: 72 }, () => ({
    x: ox, y: oy,
    vx: (Math.random() - 0.5) * 14,
    vy: (Math.random() - 0.9) * 14,
    color: colors[Math.floor(Math.random() * colors.length)],
    w: Math.random() * 7 + 3,
    h: Math.random() * 4 + 2,
    rot: Math.random() * 360,
    rotV: (Math.random() - 0.5) * 12,
    opacity: 1,
  }));

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let alive = false;
    for (const p of particles) {
      p.x += p.vx; p.y += p.vy;
      p.vy += 0.35;
      p.rot += p.rotV;
      p.opacity -= 0.013;
      if (p.opacity <= 0) continue;
      alive = true;
      ctx.save();
      ctx.globalAlpha = p.opacity;
      ctx.fillStyle = p.color;
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
      ctx.restore();
    }
    if (alive) requestAnimationFrame(draw);
    else canvas.remove();
  }
  draw();
}

// Initial load
fetchLaunches();
</script>
</body>
</html>
